<html>

<head>
    <title>Demo dataset</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2em;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1.5em;
            border: 2px solid #444;
        }

        th,
        td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #eaeaea;
        }

        tbody tr:nth-child(odd) {
            background: #fff;
        }

        tbody tr:nth-child(even) {
            background: #f0f8ff;
        }

        td ul {
            margin: 0;
            padding-left: 24px;
        }

        .json-sub-table {
            margin: 8px 0;
        }

        td a {
            color: #1565c0;
        }

        .controls {
            margin-bottom: 1em;
        }

        .toggle-btn {
            padding: 10px 20px;
            background: #1565c0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toggle-btn:hover {
            background: #0d47a1;
        }

        #turtle-view {
            display: none;
            background: #f5f5f5;
            padding: 1em;
            border: 2px solid #444;
            border-radius: 4px;
            margin-top: 1.5em;
        }

        #turtle-view pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
    <script type="application/ld+json">
    </script>
</head>

<body>
    <div class="controls">
        <button id="toggle-format" class="toggle-btn">Show Turtle Format</button>
    </div>
    <div id="dataset-table">Loading...</div>
    <div id="turtle-view"></div>
    <script>
        // Detect URLs in strings
        function linkify(str) {
            if (typeof str === "string" && str.match(/^(https?:\/\/[^\s]+)$/)) {
                return `<a href="${str}" target="_blank" rel="noopener">${str}</a>`;
            }
            return str;
        }

        // Recursively create table for the data
        function renderValue(val) {
            if (typeof val === "string" || typeof val === "number" || typeof val === "boolean") {
                return linkify(String(val));
            } else if (Array.isArray(val)) {
                if (val.length === 0) return '<i>(empty)</i>';
                if (val.every(e => ["string", "number", "boolean"].includes(typeof e))) {
                    return "<ul>" + val.map(e => `<li>${linkify(e)}</li>`).join("") + "</ul>";
                }
                else if (val.every(e => typeof e === "object" && e !== null)) {
                    const allKeys = Array.from(new Set(val.flatMap(obj => Object.keys(obj))));
                    let subTable = `<table class="json-sub-table"><thead><tr>${allKeys.map(k => `<th>${k}</th>`).join('')
                        }</tr></thead><tbody>`;
                    val.forEach(obj => {
                        subTable += '<tr>' +
                            allKeys.map(k => `<td>${renderValue(obj[k]) ?? ""}</td>`).join('') +
                            '</tr>';
                    });
                    subTable += "</tbody></table>";
                    return subTable;
                }
                return `<pre>${JSON.stringify(val, null, 2)}</pre>`;
            } else if (typeof val === "object" && val !== null) {
                let subTable = `<table class="json-sub-table"><tbody>`;
                for (const [k, v] of Object.entries(val)) {
                    subTable += `<tr><td><b>${k}</b></td><td>${renderValue(v)}</td></tr>`;
                }
                subTable += "</tbody></table>";
                return subTable;
            } else {
                return '';
            }
        }
        // Fetch and render the JSON-LD data from the local file
        let jsonldData = null;

        fetch('data.jsonld')
            .then(response => response.json())
            .then(data => {
                jsonldData = data;
                let html = '<table>';
                html += '<thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';
                Object.entries(data).forEach(([key, val]) => {
                    html += `<tr><td>${key}</td><td>${renderValue(val)}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('dataset-table').innerHTML = html;
            })
            .catch(err => {
                document.getElementById('dataset-table').textContent = 'Failed to load data!';
                console.error(err);
            });

        // Convert JSON-LD to Turtle format
        function jsonldToTurtle(data) {
            let turtle = '';
            const prefixes = {
                'schema': 'https://schema.org/',
                'csvw': 'https://www.w3.org/ns/csvw#'
            };

            // Add prefixes
            for (const [prefix, uri] of Object.entries(prefixes)) {
                turtle += `@prefix ${prefix}: <${uri}> .\n`;
            }
            turtle += '\n';

            // Main subject
            const type = data['@type'] || 'Resource';
            turtle += `<> a schema:${type} ;\n`;

            // Add properties
            const props = [];
            for (const [key, value] of Object.entries(data)) {
                if (key === '@context' || key === '@type') continue;

                const predicate = key.includes(':') ? key : `schema:${key}`;
                const valueStr = formatTurtleValue(value, '  ');
                props.push(`  ${predicate} ${valueStr}`);
            }

            turtle += props.join(' ;\n') + ' .\n';

            return turtle;
        }

        function formatTurtleValue(value, indent = '') {
            if (typeof value === 'string') {
                if (value.startsWith('http://') || value.startsWith('https://')) {
                    return `<${value}>`;
                }
                return `"${value.replace(/"/g, '\\"')}"`;
            } else if (typeof value === 'number') {
                return value;
            } else if (typeof value === 'boolean') {
                return value;
            } else if (Array.isArray(value)) {
                if (value.length === 0) return '()';
                const items = value.map(v => formatTurtleValue(v, indent + '  ')).join(',\n' + indent + '  ');
                return `(\n${indent}  ${items}\n${indent})`;
            } else if (typeof value === 'object' && value !== null) {
                if (value['@type']) {
                    let result = `[\n${indent}  a schema:${value['@type']}`;
                    for (const [k, v] of Object.entries(value)) {
                        if (k === '@type') continue;
                        const pred = k.includes(':') ? k : `schema:${k}`;
                        result += ` ;\n${indent}  ${pred} ${formatTurtleValue(v, indent + '  ')}`;
                    }
                    result += `\n${indent}]`;
                    return result;
                }
                return JSON.stringify(value);
            }
            return '""';
        }

        // Toggle button functionality
        document.getElementById('toggle-format').addEventListener('click', function () {
            const tableView = document.getElementById('dataset-table');
            const turtleView = document.getElementById('turtle-view');
            const btn = this;

            if (turtleView.style.display === 'none' || turtleView.style.display === '') {
                // Show Turtle format
                if (jsonldData) {
                    const turtleText = jsonldToTurtle(jsonldData);
                    turtleView.innerHTML = `<pre>${turtleText}</pre>`;
                }
                turtleView.style.display = 'block';
                tableView.style.display = 'none';
                btn.textContent = 'Show Table Format';
            } else {
                // Show table format
                turtleView.style.display = 'none';
                tableView.style.display = 'block';
                btn.textContent = 'Show Turtle Format';
            }
        });
    </script>
</body>

</html>